# DVPWA Comprehensive Vulnerability Analysis Report

**Analysis Date:** 2025-10-09
**Analyzed Project:** Damn Vulnerable Python Web Application (DVPWA)
**Project Location:** src/dvpwa
**Tools Used:** Bandit, Semgrep, Manual Code Review

---

## Executive Summary

This report documents a comprehensive security analysis of DVPWA, an intentionally vulnerable Python web application designed for security training. The analysis identified **11 distinct vulnerabilities** ranging from CRITICAL to INFO severity levels. All vulnerabilities documented in the official groundtruth (README.rst) were confirmed, and 6 additional security issues were discovered.

---

## Project Architecture

- **Framework:** aiohttp (async Python web framework)
- **Database:** PostgreSQL
- **Session Storage:** Redis
- **Template Engine:** Jinja2
- **Purpose:** Educational security testing platform

---

## Vulnerability Findings

### 1. SQL Injection (CRITICAL)

**Severity:** CRITICAL
**Location:** `sqli/dao/student.py:42-45`
**OWASP:** A03:2021 - Injection
**CWE:** CWE-89

**Vulnerable Code:**
```python
q = ("INSERT INTO students (name) "
     "VALUES ('%(name)s')" % {'name': name})
await cur.execute(q)
```

**Description:**
The application uses Python string formatting (`%`) to construct SQL queries, allowing attackers to inject arbitrary SQL commands through the `name` parameter.

**Exploitation Example:**
```
Payload: Robert'); DROP TABLE students CASCADE; --
Result: Table "students" is deleted from database
```

**Detection:**
- Bandit: Medium Severity, Low Confidence
- Semgrep: ERROR Severity (detected by 2 rules)
- Manual Review: Confirmed

**Impact:**
- Unauthorized data access
- Data modification or deletion
- Complete database compromise
- Privilege escalation

**Mitigation:**
Use parameterized queries (already correctly implemented in other methods):
```python
await cur.execute(
    'INSERT INTO students (name) VALUES (%s)',
    (name,)
)
```

**Groundtruth Reference:** README.rst lines 135-156

---

### 2. Session Fixation (HIGH)

**Severity:** HIGH
**Location:** `sqli/views.py:42`, `sqli/middlewares.py:20`
**OWASP:** A07:2021 - Identification and Authentication Failures

**Vulnerable Code:**

*Location 1 - No session rotation:*
```python
# sqli/views.py:42
session['user_id'] = user.id  # Session ID never rotated!
```

*Location 2 - Insecure cookie configuration:*
```python
# sqli/middlewares.py:20
storage = RedisStorage(app['redis'], httponly=False)  # Cookies accessible via JavaScript!
```

**Description:**
1. Session identifiers are not rotated on login/logout
2. Session cookies have `httponly=False`, making them accessible via JavaScript (XSS can steal sessions)

**Exploitation Steps:**
1. Attacker obtains a session cookie value (`AIOHTTP_SESSION`)
2. Victim uses the same session to authenticate
3. Attacker gains authenticated access to victim's account

**Detection:**
- Manual Review: Confirmed

**Impact:**
- Account takeover
- Unauthorized access to user data
- Session hijacking attacks

**Mitigation:**
1. Rotate session identifiers on every login and logout
2. Set `httponly=True` for session cookies
3. Regenerate session on privilege changes

**Groundtruth Reference:** README.rst lines 110-133

---

### 3. Stored Cross-Site Scripting (XSS) (HIGH)

**Severity:** HIGH
**Location:** `sqli/app.py:35`, `sqli/views.py:121-129`
**OWASP:** A03:2021 - Injection
**CWE:** CWE-79

**Vulnerable Code:**

*Location 1 - Disabled auto-escaping:*
```python
# sqli/app.py:35
setup_jinja(app, loader=PackageLoader('sqli', 'templates'),
            context_processors=[csrf_processor, auth_user_processor],
            autoescape=False)  # XSS VULNERABILITY!
```

*Location 2 - No input sanitization:*
```python
# sqli/views.py:121-129
review_text = data.get('review_text')  # No sanitization
await Review.create(conn, course_id, review_text)  # Stored unsanitized
```

*Additional Finding:*
```javascript
// sqli/static/js/materialize.js:3444
document.write(...)  // Dangerous DOM manipulation
```

**Description:**
User input is neither sanitized on input nor escaped on output, allowing attackers to inject malicious JavaScript that executes in victims' browsers.

**Exploitation Examples:**
```html
<!-- Step 1: Test HTML injection -->
<b>Is this bold?</b> Yes!

<!-- Step 2: Execute JavaScript -->
<script>
  alert('I am a stored XSS. Your cookies are: ' + document.cookie);
</script>

<!-- Step 3: Advanced exploitation -->
<img src="nonexistent" onerror="alert(document.cookie)">
```

**Detection:**
- Bandit: Not detected
- Semgrep: ERROR Severity (document.write detection)
- Manual Review: Confirmed

**Impact:**
- Cookie theft and session hijacking
- Credential harvesting
- Malware distribution
- Website defacement
- Phishing attacks

**Mitigation:**
1. Set `autoescape=True` in Jinja2 configuration
2. Sanitize input using libraries like Bleach
3. Implement Content Security Policy (CSP) headers
4. Use `textContent` instead of `innerHTML` in JavaScript

**Groundtruth Reference:** README.rst lines 158-203

---

### 4. Weak Password Hashing (MD5) (HIGH)

**Severity:** HIGH
**Location:** `sqli/dao/user.py:41`
**OWASP:** A02:2021 - Cryptographic Failures
**CWE:** CWE-327

**Vulnerable Code:**
```python
def check_password(self, password: str):
    return self.pwd_hash == md5(password.encode('utf-8')).hexdigest()
```

**Description:**
Passwords are hashed using MD5 without salting, making them vulnerable to:
1. Statistical analysis (identical passwords = identical hashes)
2. Rainbow table attacks
3. Brute force attacks (MD5 is fast to compute)
4. Collision attacks (MD5 is cryptographically broken)

**Statistical Analysis Example:**
```sql
sqli=# SELECT pwd_hash, array_agg(username), count(*)
sqli-# FROM "users"
sqli-# GROUP BY pwd_hash
sqli-# ORDER BY count(*) DESC;

             pwd_hash             |   array_agg    | count
----------------------------------+----------------+-------
 5f4dcc3b5aa765d61d8327deb882cf99 | {j.doe,s.king} |     2
 1da0bac388e8e0409a83e121e1af6ef4 | {p.parker}     |     1
 17c4520f6cfd1ab53d8745e84681eb49 | {superadmin}   |     1
(3 rows)
```

**Detection:**
- Bandit: High Severity, High Confidence
- Semgrep: WARNING Severity, High Likelihood, Medium Confidence
- Manual Review: Confirmed

**Impact:**
- Password cracking via rainbow tables (CrackStation, etc.)
- Bulk password compromise if database is leaked
- User account takeover

**Mitigation:**
Use modern password hashing algorithms:
```python
import bcrypt

# Hashing
hashed = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())

# Verification
bcrypt.checkpw(password.encode('utf-8'), stored_hash)
```

**Alternatives:** argon2, scrypt, PBKDF2

**Groundtruth Reference:** README.rst lines 205-251

---

### 5. Cross-Site Request Forgery (CSRF) (HIGH)

**Severity:** HIGH
**Location:** `sqli/app.py:27`
**OWASP:** A01:2021 - Broken Access Control

**Vulnerable Code:**
```python
app = Application(
    debug=True,
    middlewares=[
        session_middleware,
        # csrf_middleware,  # COMMENTED OUT!
        error_middleware,
    ]
)
```

**Description:**
CSRF protection middleware is implemented but commented out, allowing attackers to forge requests on behalf of authenticated users.

**Vulnerable Endpoints:**
- POST `/` (login)
- POST `/students/` (create student)
- POST `/courses/` (create course)
- POST `/courses/{id}/review` (submit review)
- POST `/students/{student_id}/evaluate/{course_id}` (grade student)
- POST `/logout/`

**Exploitation:**
Attacker creates malicious webpage:
```html
<form action="http://localhost:8080/students/" method="POST">
    <input type="hidden" name="name" value="Malicious Student">
</form>
<script>document.forms[0].submit();</script>
```

**Detection:**
- Manual Review: Confirmed

**Impact:**
- Unauthorized actions performed as victim
- Data manipulation
- Account compromise

**Mitigation:**
1. Uncomment `csrf_middleware` in app.py
2. Include CSRF tokens in all forms
3. Validate CSRF tokens on all POST requests

**Groundtruth Reference:** README.rst lines 253-256 (mentioned as "TBA")

---

### 6. Missing Authorization Checks (MEDIUM)

**Severity:** MEDIUM
**Location:** Multiple endpoints
**OWASP:** A01:2021 - Broken Access Control

**Vulnerable Endpoints:**

*No authentication required:*
```python
# sqli/views.py:52-60
@template('students.jinja2')
async def students(request: Request):
    # No @authorize() decorator!
    if request.method == 'POST':
        await Student.create(conn, data['name'])

# sqli/views.py:84-93
@template('courses.jinja2')
async def courses(request: Request):
    # No @authorize() decorator!
    if request.method == 'POST':
        await Course.create(conn, data['title'], data['description'])

# sqli/views.py:112-131
@template('review.jinja2')
async def review(request: Request):
    # No @authorize() decorator!
    if request.method == 'POST':
        await Review.create(conn, course_id, review_text)
```

**Description:**
Critical endpoints lack the `@authorize()` decorator, allowing unauthenticated users to perform privileged operations.

**Detection:**
- Manual Review: Confirmed

**Impact:**
Unauthenticated users can:
- Create students
- Create courses
- Submit reviews
- View all data

**Mitigation:**
Add `@authorize()` decorator to sensitive endpoints:
```python
from sqli.utils.auth import authorize

@authorize()
@template('students.jinja2')
async def students(request: Request):
    ...
```

**Groundtruth Reference:** Not documented in README

---

### 7. No Rate Limiting / Brute Force Protection (MEDIUM)

**Severity:** MEDIUM
**Location:** `sqli/views.py:33-45`
**OWASP:** A07:2021 - Identification and Authentication Failures

**Vulnerable Code:**
```python
# sqli/views.py:33-45
if request.method == 'POST':
    username = data['username']
    password = data['password']
    user = await User.get_by_username(conn, username)
    if user and user.check_password(password):
        session['user_id'] = user.id
    # No rate limiting, no account lockout, no CAPTCHA
```

**Description:**
The login endpoint has no rate limiting, allowing unlimited authentication attempts.

**Detection:**
- Manual Review: Confirmed

**Impact:**
- Password brute force attacks
- Credential stuffing attacks
- Denial of service via repeated requests
- Account enumeration

**Mitigation:**
1. Implement rate limiting (e.g., 5 attempts per 15 minutes)
2. Add CAPTCHA after failed attempts
3. Implement account lockout policies
4. Add delays after failed login attempts
5. Log and monitor authentication failures

**Groundtruth Reference:** Not documented in README

---

### 8. Debug Mode Enabled in Production (LOW)

**Severity:** LOW
**Location:** `sqli/app.py:24`
**OWASP:** A05:2021 - Security Misconfiguration

**Vulnerable Code:**
```python
app = Application(
    debug=True,  # Should be False in production!
    middlewares=[...]
)
```

**Description:**
Debug mode is enabled, exposing sensitive information in error messages.

**Detection:**
- Manual Review: Confirmed

**Impact:**
Information disclosure including:
- Full stack traces
- Source code paths
- Configuration details
- Variable values
- Database schema information

**Mitigation:**
```python
import os
app = Application(
    debug=os.environ.get('ENV') == 'development',
    middlewares=[...]
)
```

**Groundtruth Reference:** Not documented in README

---

### 9. Docker Security Misconfigurations (LOW)

**Severity:** LOW
**Location:** `docker-compose.yml:11` (redis service)
**OWASP:** A05:2021 - Security Misconfiguration
**CWE:** CWE-732

**Issues:**

*Missing no-new-privileges flag:*
```yaml
redis:
  # Missing: security_opt: [no-new-privileges:true]
```

*Writable root filesystem:*
```yaml
redis:
  # Missing: read_only: true
```

**Description:**
1. Service allows privilege escalation via setuid/setgid binaries
2. Container filesystem is writable, allowing attackers to modify files or download payloads

**Detection:**
- Semgrep: WARNING Severity (2 rules detected both issues)

**Impact:**
- Privilege escalation within container
- Persistent backdoors
- Container escape potential

**Mitigation:**
```yaml
redis:
  security_opt:
    - no-new-privileges:true
  read_only: true
  tmpfs:
    - /tmp
```

**Groundtruth Reference:** Not documented in README

---

### 10. Regular Expression Denial of Service (ReDoS) (LOW)

**Severity:** LOW
**Location:** `sqli/static/js/materialize.js:565`
**OWASP:** A05:2021 - Security Misconfiguration
**CWE:** CWE-1333

**Vulnerable Code:**
```javascript
// Line 565
new RegExp(userControlledInput)  // Non-literal regex
```

**Description:**
Creating RegExp from user input can cause catastrophic backtracking, blocking the main thread.

**Detection:**
- Semgrep: WARNING Severity, Medium Likelihood, Low Confidence

**Impact:**
- Application freeze/hang
- Denial of Service
- Poor user experience

**Mitigation:**
1. Use hardcoded regex patterns
2. Validate input before creating regex
3. Use regex sanitization libraries (recheck)

**Groundtruth Reference:** Not documented in README

---

### 11. Insecure Format Strings (INFO)

**Severity:** INFO
**Location:** `sqli/static/js/materialize.js` (lines 645, 661, 699)
**OWASP:** A01:2021 - Broken Access Control
**CWE:** CWE-134

**Vulnerable Code:**
```javascript
// String concatenation in console.log
console.log("Message: " + userInput)
```

**Description:**
String concatenation in logging functions can allow attackers to forge log messages if they inject format specifiers.

**Detection:**
- Semgrep: INFO Severity (3 occurrences)

**Impact:**
- Log injection
- Log forgery
- Security monitoring evasion

**Mitigation:**
```javascript
// Use separate arguments
console.log("User:", user, "Action:", action);
```

**Groundtruth Reference:** Not documented in README

---

## Vulnerability Summary Table

| # | Vulnerability | Severity | Location | OWASP 2021 | CWE | Detected By |
|---|---------------|----------|----------|------------|-----|-------------|
| 1 | SQL Injection | CRITICAL | dao/student.py:42 | A03 | CWE-89 | Bandit, Semgrep, Manual |
| 2 | Session Fixation | HIGH | views.py:42, middlewares.py:20 | A07 | - | Manual |
| 3 | Stored XSS | HIGH | app.py:35, views.py:121 | A03 | CWE-79 | Semgrep, Manual |
| 4 | Weak Password Hash | HIGH | dao/user.py:41 | A02 | CWE-327 | Bandit, Semgrep, Manual |
| 5 | CSRF | HIGH | app.py:27 | A01 | - | Manual |
| 6 | Missing Authorization | MEDIUM | Multiple endpoints | A01 | - | Manual |
| 7 | No Rate Limiting | MEDIUM | views.py:33 | A07 | - | Manual |
| 8 | Debug Mode | LOW | app.py:24 | A05 | - | Manual |
| 9 | Docker Misconfig | LOW | docker-compose.yml:11 | A05 | CWE-732 | Semgrep |
| 10 | ReDoS | LOW | materialize.js:565 | A05 | CWE-1333 | Semgrep |
| 11 | Format String | INFO | materialize.js:645,661,699 | A01 | CWE-134 | Semgrep |

---

## OWASP Top 10 2021 Coverage

This application demonstrates the following OWASP Top 10 vulnerabilities:

- **A01:2021 - Broken Access Control:** CSRF, Missing Authorization, Format Strings
- **A02:2021 - Cryptographic Failures:** Weak MD5 Password Hashing
- **A03:2021 - Injection:** SQL Injection, Stored XSS
- **A05:2021 - Security Misconfiguration:** Debug Mode, Docker Misconfigurations, ReDoS
- **A07:2021 - Identification and Authentication Failures:** Session Fixation, No Rate Limiting

---

## Tool Effectiveness Analysis

### Detection Coverage by Tool

| Vulnerability | Bandit | Semgrep | Manual Review |
|---------------|--------|---------|---------------|
| SQL Injection | ✓ | ✓✓ | ✓ |
| Session Fixation | ✗ | ✗ | ✓ |
| Stored XSS | ✗ | ✓ | ✓ |
| Weak Password Hash | ✓ | ✓ | ✓ |
| CSRF | ✗ | ✗ | ✓ |
| Missing Authorization | ✗ | ✗ | ✓ |
| No Rate Limiting | ✗ | ✗ | ✓ |
| Debug Mode | ✗ | ✗ | ✓ |
| Docker Misconfig | ✗ | ✓✓ | ✓ |
| ReDoS | ✗ | ✓ | ✗ |
| Format String | ✗ | ✓✓✓ | ✗ |

### Tool Statistics

**Bandit:**
- Vulnerabilities detected: 2 / 11 (18%)
- Total issues found: 2
- False positives: 0
- Strengths: Python-specific security issues, cryptography
- Weaknesses: Logic flaws, configuration issues

**Semgrep:**
- Vulnerabilities detected: 6 / 11 (55%)
- Total issues found: 10 (some duplicates)
- False positives: 0
- Strengths: Multi-language, configuration analysis, comprehensive rules
- Weaknesses: Business logic flaws

**Manual Code Review:**
- Vulnerabilities detected: 11 / 11 (100%)
- Strengths: Logic flaws, business logic, architectural issues
- Weaknesses: Time-consuming, requires expertise

---

## Groundtruth Documentation Sources

### 1. Official Project Documentation

**Location:** `src/dvpwa/README.rst` (lines 107-263)

**Documented Vulnerabilities:**
- Session Fixation (lines 110-133)
  - Reproduction steps provided
  - Mitigation strategy included
- SQL Injection (lines 135-156)
  - Exploit example: `Robert'); DROP TABLE students CASCADE; --`
  - Mitigation recommendations
- Stored XSS (lines 158-203)
  - Multiple payload examples
  - Detailed exploitation steps
  - Configuration fix explained
- Weak Password Hashing - MD5 (lines 205-251)
  - SQL query for statistical analysis
  - Rainbow table reference (CrackStation)
  - Alternative algorithms recommended
- CSRF (lines 253-256)
  - Mentioned but marked "TBA" (To Be Announced)

### 2. GitHub Repository

**URL:** https://github.com/anxolerd/dvpwa

**Contains:**
- Source code with intentional vulnerabilities
- Complete README documentation
- Configuration examples
- Docker setup with vulnerable configurations

### 3. This Analysis

**Additional Findings Not in Official Groundtruth:**
- Missing Authorization Checks (endpoints without @authorize)
- No Rate Limiting on authentication
- Debug Mode enabled
- Docker security misconfigurations
- ReDoS potential in JavaScript
- Insecure format strings

---

## Scan Results Files

### Bandit Results
**File:** `sast_report/bandit-results.json`
**Format:** JSON
**Issues Found:** 2

### Semgrep Results
**File:** `sast_report/semgrep_results.json`
**Format:** JSON
**Issues Found:** 10
**Scan Time:** 21.8 seconds
**Files Scanned:** 55

---

## Recommendations

### For Security Testing
1. Use this application for:
   - Security tool evaluation
   - Penetration testing practice
   - Security training and education
   - SAST/DAST tool benchmarking

2. Expected tool capabilities:
   - Should detect SQL injection (CWE-89)
   - Should detect weak cryptography (CWE-327)
   - Should identify XSS vulnerabilities (CWE-79)
   - Should flag debug mode and configuration issues

### For Educational Use
1. Study each vulnerability in isolation
2. Practice exploitation techniques safely
3. Implement and test mitigation strategies
4. Compare tool detection capabilities
5. Understand OWASP Top 10 practically

### Never Use in Production
- This application is intentionally insecure
- Contains critical vulnerabilities
- Designed for educational purposes only
- Do not expose to internet
- Use only in isolated environments

---

## Conclusion

DVPWA successfully demonstrates **11 distinct security vulnerabilities** spanning multiple OWASP Top 10 categories. The application serves as an excellent educational platform with well-documented vulnerabilities (5 in official groundtruth) and additional realistic security issues (6 discovered through analysis).

The project's README provides comprehensive groundtruth documentation including:
- Detailed reproduction steps
- Exploit examples
- Expected results
- Mitigation strategies

This makes DVPWA a valuable resource for:
- Security tool evaluation
- Security training programs
- Penetration testing practice
- Understanding web application vulnerabilities

**Key Insight:** Automated tools (Bandit, Semgrep) detected 55% of vulnerabilities, while manual code review identified 100%, emphasizing the importance of combining automated scanning with human expertise for comprehensive security assessment.

---

## References

1. OWASP Top 10 2021: https://owasp.org/Top10/
2. DVPWA GitHub Repository: https://github.com/anxolerd/dvpwa
3. CWE Database: https://cwe.mitre.org/
4. Bandit Documentation: https://bandit.readthedocs.io/
5. Semgrep Rules: https://semgrep.dev/r
6. OWASP SQL Injection Prevention Cheat Sheet
7. OWASP XSS Prevention Cheat Sheet
8. OWASP Password Storage Cheat Sheet
9. Docker Security Cheat Sheet

---

**Report Generated:** 2025-10-09
**Analyst:** Automated Security Analysis with Manual Review
**Tools Version:**
- Bandit: 1.8.6
- Semgrep: 1.139.0
